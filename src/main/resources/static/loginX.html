<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë¶€ë™ì‚° ì„œë¹„ìŠ¤ ë¡œê·¸ì¸</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (Inter & Noto Sans KR) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap"
            rel="stylesheet"
    />

    <style>
        body {
            font-family: "Inter", "Noto Sans KR", sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center px-4">
<div class="w-full max-w-md">
    <!-- ë¡œê·¸ì¸ ì¹´ë“œ -->
    <div class="bg-white rounded-3xl shadow-lg overflow-hidden">
        <!-- í—¤ë” -->
        <div class="px-6 pt-6 pb-4 text-center">
            <!-- ë¡œê³  -->
            <div class="mb-4">
                <div
                        class="w-16 h-16 mx-auto bg-green-400 rounded-2xl flex items-center justify-center mb-3"
                >
                    <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-8 w-8 text-white"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                            stroke-width="2"
                    >
                        <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m0 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h3a1 1 0 001-1V10m-9-10"
                        />
                    </svg>
                </div>
                <h1 class="text-xl font-bold text-gray-800">ë¶€ë™ì‚° ì„œë¹„ìŠ¤</h1>
                <p class="text-gray-600 text-sm mt-1">
                    ë¡œê·¸ì¸í•˜ì—¬ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ì„¸ìš”
                </p>
            </div>
        </div>

        <!-- ë¡œê·¸ì¸ í¼ -->
        <div class="px-6 pb-6">
            <form id="loginForm" class="space-y-4">
                <!-- ì´ë©”ì¼ ì…ë ¥ -->
                <div>
                    <label
                            for="email"
                            class="block text-sm font-medium text-gray-700 mb-2"
                    >ì´ë©”ì¼</label>
                    <input
                            type="email"
                            id="email"
                            name="email"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-2xl focus:outline-none focus:border-green-400 focus:ring-1 focus:ring-green-400"
                            placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”"
                    />
                </div>

                <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ -->
                <div>
                    <label
                            for="password"
                            class="block text-sm font-medium text-gray-700 mb-2"
                    >ë¹„ë°€ë²ˆí˜¸</label>
                    <input
                            type="password"
                            id="password"
                            name="password"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-2xl focus:outline-none focus:border-green-400 focus:ring-1 focus:ring-green-400"
                            placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                    />
                </div>

                <!-- ë¡œê·¸ì¸ ì˜µì…˜ -->
                <div class="flex items-center justify-between text-sm">
                    <label class="flex items-center">
                        <input
                                type="checkbox"
                                class="rounded border-gray-300 text-green-400 focus:ring-green-400"
                        />
                        <span class="ml-2 text-gray-600">ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€</span>
                    </label>
                    <!-- ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° -->
                    <a
                            href="#"
                            id="forgot-password-link"
                            class="text-green-500 hover:text-green-700"
                    >
                        ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°
                    </a>
                </div>

                <!-- ë¡œê·¸ì¸ ë²„íŠ¼ -->
                <button
                        type="submit"
                        class="w-full bg-green-400 hover:bg-green-500 text-white font-medium py-2 px-4 rounded-2xl transition-colors"
                >
                    ë¡œê·¸ì¸
                </button>

                <!-- íšŒì›ê°€ì… ë§í¬ -->
                <div class="text-center">
                    <p class="text-sm text-gray-600">
                        ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?
                        <a
                                href="signup.html"
                                class="text-green-500 hover:text-green-700 font-medium"
                        >íšŒì›ê°€ì…</a>
                    </p>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- AuthUtils ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
<script src="js/utils/auth-utils.js"></script>

<script type="module">
    function setToken(raw) {
        const bearer = raw?.startsWith("Bearer ") ? raw : `Bearer ${raw}`;
        localStorage.setItem("auth_token", bearer);
        window.TOKEN = bearer;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ë¡œê·¸ì•„ì›ƒ (í† í° ì œê±°)
    window.addEventListener("DOMContentLoaded", function () {
        localStorage.removeItem("auth_token");
        localStorage.removeItem("refresh_token");
        // AuthUtilsë¥¼ ì‚¬ìš©í•˜ì—¬ í† í° ì œê±°
        AuthUtils.removeToken();
        localStorage.removeItem("refreshToken");

        // sessionStorageì—ì„œë„ í† í° ì œê±°
        sessionStorage.removeItem("refreshToken");
        sessionStorage.removeItem("auth_token");
        sessionStorage.removeItem("refresh_token");

        console.log("ìë™ ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ - ëª¨ë“  í† í°ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.");
    });

    // ğŸ”¹ ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° í´ë¦­ ì‹œ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë©”ì¼ ìš”ì²­
    const forgotLink = document.getElementById("forgot-password-link");
    if (forgotLink) {
        forgotLink.addEventListener("click", async (e) => {
            e.preventDefault();

            const emailInput = document.getElementById("email");
            let email = emailInput?.value?.trim();

            if (!email) {
                email = window.prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì¬ì„¤ì •í•  ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.");
            }

            if (!email) {
                alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            try {
                const res = await fetch("/api/auth/forgot-password", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        // ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë°›ëŠ” X-App-Base-Url
                        "X-App-Base-Url": window.location.origin,
                    },
                    body: JSON.stringify({ email }),
                });

                if (!res.ok) {
                    const msg = await res.text();
                    throw new Error(msg || "ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }

                // ì»¨íŠ¸ë¡¤ëŸ¬ê°€ 204 NO_CONTENT ë³´ë‚´ë¯€ë¡œ body ì•ˆ ì½ì–´ë„ ë¨
                alert("ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.\në©”ì¼í•¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            } catch (err) {
                console.error("ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì˜¤ë¥˜:", err);
                alert(
                    err.message ||
                    "ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
                );
            }
        });
    }

    // í¼ ì œì¶œ ì²˜ë¦¬ (ë¡œê·¸ì¸)
    document
        .getElementById("loginForm")
        .addEventListener("submit", async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const email = formData.get("email");
            const password = formData.get("password");

            if (!email.trim() || !password.trim()) {
                alert("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = "ë¡œê·¸ì¸ ì¤‘...";
            submitButton.disabled = true;

            try {
                const loginResponse = await fetch("/api/auth/login", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                    }),
                });

                if (!loginResponse.ok) {
                    const errorData = await loginResponse.text();
                    throw new Error(errorData || "ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }

                const tokenData = await loginResponse.json();
                setToken(tokenData.accessToken);
                AuthUtils.setToken(tokenData.accessToken);
                localStorage.setItem("refreshToken", tokenData.refreshToken);

                const userResponse = await fetch("/api/users/me", {
                    method: "GET",
                    headers: {
                        Authorization: `Bearer ${tokenData.accessToken}`,
                        "Content-Type": "application/json",
                    },
                });

                if (!userResponse.ok) {
                    throw new Error("ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }

                const userData = await userResponse.json();

                localStorage.setItem(
                    "currentUser",
                    JSON.stringify({
                        userId: userData.id,
                        email: userData.email,
                        username: userData.username,
                        role: userData.role,
                    })
                );

                console.log("ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´:", userData);

                switch (userData.role) {
                    case "regular":
                        window.location.href = "loginO.html";
                        break;
                    case "broker":
                        window.location.href = "intermediary.html";
                        break;
                    case "admin":
                        window.location.href = "admin.html";
                        break;
                    default:
                        window.location.href = "loginO.html";
                        break;
                }
            } catch (error) {
                console.error("ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
                alert(
                    error.message ||
                    "ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
                );

                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        });
</script>
</body>
</html>
